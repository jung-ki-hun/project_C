//Change the file extension from *.txt to *.ino//
/////////////////////////////////////////////////////////////////////////////////////////
//                                        //⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣠⣤⣤⣤⣤⣤⣶⣦⣤⣄⡀⠀⠀⠀⠀⠀⠀⠀⠀     //
//     ("`-''-/").___..--''"`-._          //⠀⠀⠀⠀⠀⠀⠀⠀⢀⣴⣿⡿⠛⠉⠙⠛⠛⠛⠛⠻⢿⣿⣷⣤⡀⠀⠀⠀⠀⠀    //
//     `6_ 6  )   `-.  (     ).`-.__.`)   //⠀⠀⠀⠀⠀⠀⠀⠀⣼⣿⠋⠀⠀⠀⠀⠀⠀⠀⢀⣀⣀⠈⢻⣿⣿⡄⠀⠀⠀⠀     //
//     (_Y_.)'  ._   )  `._ `. ``-..-`    //⠀⠀⠀⠀⠀⠀⠀⣸⣿⡏⠀⠀⠀⣠⣶⣾⣿⣿⣿⠿⠿⠿⢿⣿⣿⣿⣄⠀⠀⠀    //
//    _..`--'_..-_/  /--'_.' ,'           //⠀⠀⠀⠀⠀⠀⠀⣿⣿⠁⠀⠀⢰⣿⣿⣯⠁⠀⠀⠀⠀⠀⠀⠀⠈⠙⢿⣷⡄⠀     //
//  (il),-''  (li),'  ((!.-'              //⠀⠀⣀⣤⣴⣶⣶⣿⡟⠀⠀⠀⢸⣿⣿⣿⣆⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣿⣷⠀     //
//                                        //⠀⢰⣿⡟⠋⠉⣹⣿⡇⠀⠀⠀⠘⣿⣿⣿⣿⣷⣦⣤⣤⣤⣶⣶⣶⣶⣿⣿⣿⠀   //
////////////////////////////////////////////⠀⢸⣿⡇⠀⠀⣿⣿⡇⠀⠀⠀⠀⠹⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡿⠃⠀    //
//                                        //⠀⣸⣿⡇⠀⠀⣿⣿⡇⠀⠀⠀⠀⠀⠉⠻⠿⣿⣿⣿⣿⡿⠿⠿⠛⢻⣿⡇⠀⠀    //
//     Make    : Kim Dong Hun             //⠀⣿⣿⠁⠀⠀⣿⣿⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⣿⣧⠀⠀      //
//     Update  : KR 2020/12/20 16:26      //⠀⣿⣿⠀⠀⠀⣿⣿⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⣿⣿⠀⠀      //
//     E-Mail  : 112303dh@naver.com       //⠀⣿⣿⠀⠀⠀⣿⣿⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⣿⣿⠀⠀      //
//     Develope Tool :                    //⠀⢿⣿⡆⠀⠀⣿⣿⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⣿⡇⠀⠀      //
//     Visual Stduio Code                 //⠀⠸⣿⣧⡀⠀⣿⣿⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣿⣿⠃⠀⠀      //
//                                        //⠀⠀⠛⢿⣿⣿⣿⣿⣇⠀⠀⠀⠀⠀⣰⣿⣿⣷⣶⣶⣶⣶⠶⠀⢠⣿⣿⠀⠀⠀    //
////////////////////////////////////////////⠀⠀⠀⠀⠀⠀⠀⣿⣿⠀⠀⠀⠀⠀⣿⣿⡇⠀⣽⣿⡏⠁⠀⠀⢸⣿⡇⠀⠀⠀     //
//                                          ⠀⠀⠀⠀⠀⠀⠀⣿⣿⠀⠀⠀⠀⠀⣿⣿⡇⠀⣽⣿⡏⠁⠀⠀⢸⣿⡇⠀⠀⠀     //
//                                          ⠀⠀⠀⠀⠀⠀⠀⢿⣿⣦⣄⣀⣠⣴⣿⣿⠁⠀⠈⠻⣿⣿⣿⣿⡿⠏⠀⠀⠀⠀    //
//                                          ⠀⠀⠀⠀⠀⠀⠀⠈⠛⠻⠿⠿⠿⠿⠋⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀      //
//                                                                                     //
//                                                                                     //
//        .          。            •       ﾟ      。       .                            //
//                                                                                     //
//                 .                .               。       。   .                    //
//                                                                                     //
//        .       。                ඞ 。 .        •             •                      //
//                                                                                     //
//              ﾟ       Green was not An Impostor.    。   .                            //
//                                                                                     //
//              '          1 Impostor remains           。                             //
//                                                                                     //
//              ﾟ         .         . ,            .    .         ﾟ                     //
//                                                                                     //
//                                                                                     //
//                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////////////
//        주석 목차                                                                     //
//     [0] 헤더파일                                                                     //
//     [1] 변수정의                                                                     //
//     [2] 함수정리                                                                     //
//     [3] 기기부팅시 초기설정                                                           //
//     [4] 기기동작                                                                     //
//        Fin                                                                          //
/////////////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////////////
//[0] 헤더파일////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////

#include <ESP32AnalogRead.h>
#include <analogWrite.h>

#include <Adafruit_Sensor.h>
#include <DHT.h>
#include <DHT_U.h>
#include <Adafruit_SSD1306.h> // OLED기기에 맞춰서 헤더파일 수정해야함 (128x64 I2C 0x3C사양의 OLED해당된 부품으로 해야함.)

#include <driver/adc.h>

#include <WiFi.h>
#include <WiFiClient.h>
#include <WebServer.h>

#include <MySQL_Connection.h>
#include <MySQL_Cursor.h>

#include "time.h"

/////////////////////////////////////////////////////////////////////////////////////////
//[1] 변수정의////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////

//"0기기 관련 정보" "This Device "
#define A00
const char *ntpServer = "pool.ntp.org";
uint8_t timeZone = 9;
uint8_t summerTime = 0; // 3600
struct tm timeinfo;

//"1온습도센서" "DHT11"
#define DATA_PIN 2
double temp = 0;
double humi = 0;
DHT_Unified dht(DATA_PIN, DHT11);

//"2미세먼지" "gp2y1014au0f"
//int dustPin = A0; 이거안쓰고 ADC씀
double dustVal = 0;
double calcVoltage = 0;
double offTime = 9680;
int ledPower = 1; //측정용LED초록색
int delayTime = 280;
int delayTime2 = 40;

//"3펜 모터(트랜지스터 NPN스위치 방식)" "120mm Pen 12V (2N2222 NPN Transister Switch) (12V Power Another Way)"
int penOnOff = 23;
int penStatus = 1;

//"4상태출력 OLED" "OLED 0.96'inch I2C, 0x3C"
Adafruit_SSD1306 oled = Adafruit_SSD1306(128, 32, &Wire);

//"5서버통신" "상호작용 : ESP32 <> 무선WiFi연결(데이터되어야함)"
const char *ssid = "122BTEST";
const char *password = "122b122b";
String text = "";
const String page PROGMEM = "<head>"
                            " <script src='https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js'></script>"
                            " </head>"
                            " <body>"
                            " <h1>Sensor to ESP32 Web Server</h1><h2>Temperature:</h2> <h2 id='temp'>"
                            "</h2>\r\n"
                            " <h2>Humidity:</h2><h2 id='humi'>"
                            "</h2>\r\n"
                            " <script>\r\n"
                            " $(document).ready(function(){\r\n"
                            " setInterval(getData,1000);\r\n"
                            " function getData(){\r\n"
                            " $.ajax({\r\n"
                            "  type:'GET',\r\n"
                            "  url:'data',\r\n"
                            "  success: function(data){\r\n"
                            "  var s = data.split('-');\r\n"
                            "  $('#temp').html(s[0]);\r\n"
                            "  $('#humi').html(s[1]);\r\n"
                            "}\r\n"
                            "}).done(function() {\r\n"
                            "  console.log('ok');\r\n"
                            "})\r\n"
                            "}\r\n"
                            "});"
                            "</script>\r\n"
                            "</body>";

WebServer server(80);

//"6MySQL 연동"
IPAddress server_addr(203, 241, 228, 134); // IP of the MySQL server here
char userSQL[] = "root";                   // MySQL user login username
char passwordSQL[] = "root";               // MySQL user login password
char query1[] = "SELECT * FROM ghtest.AIR_database";
String query2;
char queryC2[256];

WiFiClient client;
MySQL_Connection conn((Client *)&client);
MySQL_Cursor cur = MySQL_Cursor(&conn);
/////////////////////////////////////////////////////////////////////////////////////////
//[2] 함수 정리///////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////

String _0_getTimeNow()
{
    if (!getLocalTime(&timeinfo))
    {
        Serial.println("Failed to obtain time");
    }
    String strrr = (String)(timeinfo.tm_year+1900);
    strrr+="-";
    strrr+=(String)(timeinfo.tm_mon+1);
    strrr+="-";
    strrr+=(String)timeinfo.tm_mday;
    strrr+=" ";
    strrr+=(String)timeinfo.tm_hour;
    strrr+=":";
    strrr+=(String)timeinfo.tm_min;
    strrr+=":";
    strrr+=(String)timeinfo.tm_sec;
    Serial.println(strrr);
    return strrr;

}

void _1_DHT11()
{
    sensors_event_t event;
    dht.temperature().getEvent(&event);
    if (isnan(event.temperature))
    {
        temp = 0;
    }
    else
    {
        temp = (double)event.temperature;
    }
    delay(300);
    dht.humidity().getEvent(&event);
    if (isnan(event.relative_humidity))
    {
        humi = 0;
    }
    else
    {
        humi = (double)event.relative_humidity;
    }
    Serial.println("");
    Serial.print("temp[*C]: ");
    Serial.println(temp);
    Serial.print("humi[%]: ");
    Serial.println(humi);
    delay(300);
}

void _2_GP2Y1014AU0F()
{
    digitalWrite(ledPower, LOW); // power on the LED
    delayMicroseconds(delayTime);
    dustVal = adc1_get_raw(ADC1_CHANNEL_0); // read the dust value // read the dust value via pin 5 on the sensor
    
    if (dustVal > 0)
    {
        calcVoltage = dustVal * (5.0 / 4096);
        delayMicroseconds(delayTime2);
        digitalWrite(ledPower, HIGH); // turn the LED off
        delayMicroseconds(offTime);
        delay(100);
        calcVoltage = (calcVoltage - 0.0) / 0.005;
        Serial.print("Dust[ug/m3]: ");
        Serial.println(calcVoltage);
    }
    else{
        calcVoltage = 0.0;
        delayMicroseconds(delayTime2);
        digitalWrite(ledPower, HIGH); // turn the LED off
        delayMicroseconds(offTime);
        delay(100);
        calcVoltage = 0.1;
        Serial.print("Dust[ug/m3]: ");
        Serial.println(calcVoltage);
    }
}

void _3_Pen()
{
    switch (penStatus)
    {
    case 1:
        digitalWrite(penOnOff, HIGH);
    case 0:
        digitalWrite(penOnOff, LOW);
    }
    Serial.print("Status:");
    Serial.println(penStatus);

}

void _4_OLED()
{
    oled.clearDisplay();
    oled.setCursor(0, 0);
    oled.print("Temp: ");
    oled.print(temp, 1);
    oled.println("*C");
    oled.print("Humi: ");
    oled.print(humi, 1);
    oled.println("%");
    oled.print("Dust: ");
    oled.print(calcVoltage, 2);
    oled.println("ug/m3");
    oled.print("Status: ");
    oled.println(penStatus);
    oled.setCursor(100,0);

    oled.print(timeinfo.tm_hour);
    oled.print(":");
    oled.print(timeinfo.tm_min);
    oled.display();
}

void _5_Network()
{
    oled.clearDisplay();
    oled.setCursor(0, 0);

    WiFi.mode(WIFI_STA);
    WiFi.begin(ssid, password);
    while (WiFi.status() != WL_CONNECTED)
    {
        delay(500);
        Serial.print(".");
        oled.print(".");
        oled.display();
    }
    oled.clearDisplay();
    oled.setCursor(0, 0);
    oled.print("Connected to ");
    oled.println(ssid);
    oled.print("IP address: ");
    oled.println(WiFi.localIP());
    oled.display();
    Serial.print("Connected to ");
    Serial.println(ssid);
    Serial.print("IP address: ");
    Serial.println(WiFi.localIP());
    delay(5000);

    server.on("/data", []() {
        text = (String)temp;
        text += "-";
        text += (String)humi;
        Serial.println(text);
        server.send(200, "text/plain", text);
    });

    server.on("/", []() {
        server.send(200, "text/html", page);
    });

    server.begin();
    oled.clearDisplay();
    oled.setCursor(0, 0);
    oled.println("HTTP server started");
    Serial.println("HTTP server started");
    oled.display();
    delay(1000);
}

void _6_MySQL()
{
    conn.connect(server_addr, 3306, userSQL, passwordSQL);
    row_values *row = NULL;
    int setONOFF = 1;
    delay(1000);
    MySQL_Cursor *cur_mem = new MySQL_Cursor(&conn);
    cur_mem->execute(query1);
    column_names *columns = cur_mem->get_columns();
    do
    {
        row = cur_mem->get_next_row();
        if (row != NULL)
        {
            setONOFF = atoi(row->values[5]);
            penStatus = penStatus == setONOFF ? penStatus : setONOFF;
        }
    } while (row != NULL);
    query2="UPDATE ghtest.AIR_database SET ";
    query2+=" misae='";
    query2+=(String)calcVoltage;
    query2+="', temperature='";
    query2+=(String)temp;
    query2+="', humidity='";
    query2+=(String)humi;
    query2+="', is_turned_on='";
    query2+=(String)penStatus;
    query2+="', machine_id='AIR0A01A' ";
    query2+="WHERE obid = 1;";
    query2.toCharArray(queryC2,query2.length());
    cur_mem->execute(queryC2);
    delete cur_mem;
}
/////////////////////////////////////////////////////////////////////////////////////////
//[3]기기 부팅시 초기설정//////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////

void setup()
{

    //"0 Debug" 시리얼
    Serial.begin(115200);
    while (!Serial)
    {
    }

    //"0 전체적인 아날로그신호" 를 ADC방식으로 받기위해 세팅
    adc1_config_width(ADC_WIDTH_BIT_12);

    //"1온습도센서" 아날로그신호 세팅
    dht.begin();

    //"2미세먼지"
    adc1_config_channel_atten(ADC1_CHANNEL_0, ADC_ATTEN_DB_0);
    pinMode(ledPower, OUTPUT);

    //"3펜 모터(스위치방식)"
    pinMode(penOnOff, OUTPUT);

    //"4상태출력 OLED"
    oled.begin(SSD1306_SWITCHCAPVCC, 0x3C); // initialize with the I2C addr 0x3C (for the 128x32)
    oled.display();
    oled.setTextSize(1);
    oled.setTextColor(WHITE);

    //"5서버통신" +"4 OLED Display"
    _5_Network();

    //"6MySQL 연결"
    Serial.println("Connect to MySQL Server");
    oled.clearDisplay();
    oled.setCursor(0, 0);
    oled.print("Connect to MySQL Server");
    oled.display();
    if (conn.connect(server_addr, 3306, userSQL, passwordSQL))
    {
        oled.print(".");
        oled.display();
        delay(1000);
    }
    else
    {
        Serial.println("Connection failed.");
        oled.println("");
        oled.println("Connection failed.");
    }

    //"0현재시간 동기화 설정"
    configTime(3600 * timeZone, 3600 * summerTime, ntpServer);
}

/////////////////////////////////////////////////////////////////////////////////////////
//[4]기기 동작///////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////

void loop()
{
    Serial.println("!Start!");

    //"1온습도센서" "temp,humi에 double형식으로 storage"
    _1_DHT11();

    //"2미세먼지" "calcVoltage에 double형식으로 storage"
    _2_GP2Y1014AU0F();

    //"3펜" "penStatus에 int형식으로 storage"
    _3_Pen();

    //"4상태출력 OLED"
    _4_OLED();

    //"5서버통신"
    server.handleClient();

    //"6MySQL 연결"
    _6_MySQL();

    Serial.println("!End!");
    delay(2000);
}

/////////////////////////////////////////////////////////////////////////////////////////
//                                   //Fin//                                           //
/////////////////////////////////////////////////////////////////////////////////////////
